<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FareCalculatorService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">parking-system</a> &gt; <a href="index.source.html" class="el_package">com.parkit.parkingsystem.service</a> &gt; <span class="el_source">FareCalculatorService.java</span></div><h1>FareCalculatorService.java</h1><pre class="source lang-java linenums">package com.parkit.parkingsystem.service;

import java.time.Duration;
import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;

import com.parkit.parkingsystem.constants.Fare;
import com.parkit.parkingsystem.dao.TicketDAO;
import com.parkit.parkingsystem.model.Ticket;
import com.parkit.parkingsystem.util.DateHelperUtil;
import com.parkit.parkingsystem.util.MathHelperUtil;

/**
 * @author Muriel Proton
 *
 */
<span class="fc" id="L17">public class FareCalculatorService {</span>

<span class="fc" id="L19">    private TicketDAO ticketDAO =  new TicketDAO();</span>
	
	
    /**
     * Used in Class FareCalculatorService by Method : calculateFare(Ticket)
     * @param Ticket
     * @return DURATION
     */
    public Duration getDurationOfTicket(Ticket ticket){
    	/*When not rounded the outTime == inTime
    	 * there for we need to have a outTimeSafe
    	 * first macke sure outTime has been assigned to a value
    	 * then round it.
    	 */
<span class="fc" id="L33">    	LocalDateTime outTimeSafe = null;</span>
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">		if( ticket.getOutTime() != null) {</span>
<span class="fc" id="L35">			outTimeSafe = ticket.getOutTime().plusSeconds(1).truncatedTo(ChronoUnit.SECONDS);</span>
		}
		/*now we can test safely if the out time is after the in time. The test will always work.
		 * or not ^v^ */
<span class="pc bpc" id="L39" title="1 of 4 branches missed.">		if( outTimeSafe == null || ticket.getInTime().isAfter(outTimeSafe) ){</span>
<span class="fc" id="L40">            throw new IllegalArgumentException(&quot;Out time provided is incorrect: &quot;+outTimeSafe);</span>
        }

<span class="fc" id="L43">        LocalDateTime inHour = ticket.getInTime();</span>
<span class="fc" id="L44">        LocalDateTime outHour = outTimeSafe;</span>

<span class="fc" id="L46">        Duration lengthOfTimeDuringWhenCarWasParked = DateHelperUtil.findLengthOfTimeBetweenTwoLocalDateTimes(inHour, outHour);</span>
<span class="fc" id="L47">        return lengthOfTimeDuringWhenCarWasParked;</span>
    }
    /**
     * Used in Class ExitingVehicleController by Method : getExitingVehiculePriceFare(Ticket)
     * @param Ticket
     * @return DOUBLE
     */
    public double calculateFare(Ticket ticket){
<span class="fc" id="L55">        double parkingTypeRatePerHour = getRatePerHour(ticket);</span>
<span class="fc" id="L56">        Duration lengthOfTimeDuringWhenCarWasParked = getDurationOfTicket(ticket);</span>
<span class="fc" id="L57">        double hoursOfParkedTime = ifWasLessThanThirtyMinutesGetItFree(lengthOfTimeDuringWhenCarWasParked);</span>
<span class="fc" id="L58">        double priceRateForCustumer = getPriceRateForCustumer(ticket.getVehicleRegNumber());</span>
<span class="fc" id="L59">        double parkingFee = MathHelperUtil</span>
<span class="fc" id="L60">        		.roundingPrice(hoursOfParkedTime * parkingTypeRatePerHour * priceRateForCustumer);</span>
<span class="fc" id="L61">        ticket.setPrice(parkingFee);</span>
<span class="fc" id="L62">        return parkingFee;</span>
    }
    /**
     * Used in Class FareCalculatorService by Method : calculateFare(DURATION)
     * @param Ticket
     * @return DOUBLE
     */
	private double getRatePerHour(Ticket ticket) {
		double parkingTypeRatePerHour;
<span class="pc bpc" id="L71" title="1 of 3 branches missed.">        switch (ticket.getParkingSpot().getParkingType()){</span>
            case CAR: {
<span class="fc" id="L73">            	parkingTypeRatePerHour = Fare.CAR_RATE_PER_HOUR;</span>
<span class="fc" id="L74">            	break;</span>
            }
            case BIKE: {
<span class="fc" id="L77">            	parkingTypeRatePerHour = Fare.BIKE_RATE_PER_HOUR;</span>
<span class="fc" id="L78">            	break;</span>
            }
<span class="nc" id="L80">            default: throw new IllegalArgumentException(&quot;Unkown Parking Type&quot;);</span>
        }
<span class="fc" id="L82">		return parkingTypeRatePerHour;</span>
	}
    /**
     * Used in Class FareCalculatorService by Method : calculateFare(DURATION)
     * @param STRING
     * @return DOUBLE
     */
    private double getPriceRateForCustumer(String vehicleRegNumber) {
<span class="fc bfc" id="L90" title="All 2 branches covered.">    	if(ticketDAO.isItALoyalCustomer(vehicleRegNumber)) {</span>
<span class="fc" id="L91">    		return 0.95;</span>
    	}else {
<span class="fc" id="L93">    		return 1;</span>
    	}
	}
	/**
     * Used in Class ExitingVehicleController by Method : ifWasLessThanThirtyMinutesGetItFree(DURATION)
     * @param DURATION
     * @return BOOLEAN
     */
    public boolean wasItThirtyMinutes(Duration lengthOfTimeDuringWhenCarWasParked) {
<span class="fc" id="L102">    	Duration thirtyMinutes = Duration.ofMinutes(30);</span>
    	/**
    	 * Duration &lt; thirtyMinutes = Duration.compareTo(thirtyMinutes) = -1
    	 * Duration == thirtyMinutes = Duration.compareTo(thirtyMinutes) = 0 
    	 * Duration &gt; thirtyMinutes = Duration.compareTo(thirtyMinutes) = 1
    	 */
<span class="fc" id="L108">    	int wasItInferiorOrEqual = lengthOfTimeDuringWhenCarWasParked.compareTo(thirtyMinutes);</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">    	if(wasItInferiorOrEqual &lt; 1) {</span>
<span class="fc" id="L110">    		return true;</span>
    	}else {
<span class="fc" id="L112">    		return false;</span>
    	}
	}
    /**
     * Used in Class ExitingVehicleController by Method : calculateFare(Ticket)
     * @param DURATION
     * @return DOUBLE
     */
    public double ifWasLessThanThirtyMinutesGetItFree(Duration lengthOfTimeDuringWhenCarWasParked) {
<span class="fc bfc" id="L121" title="All 2 branches covered.">    	if(wasItThirtyMinutes(lengthOfTimeDuringWhenCarWasParked)) {</span>
<span class="fc" id="L122">    		return 0.0;</span>
    	}else {
<span class="fc" id="L124">    		return DateHelperUtil.transformDurationIntoDouble(lengthOfTimeDuringWhenCarWasParked);</span>
    	}
	}
    
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>